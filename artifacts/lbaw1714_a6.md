# A6: Indexes, triggers, user functions and population

 GROUP1714, 01/04/2018

* Daniel Ribeiro de Pinho - up201505302@fe.up.pt

* Francisco José Sousa Silva - up201502860@fe.up.pt

* Rui André Rebolo Fernandes Leixo - up201504818@fe.up.pt

* Vitor Emanuel Fernandes Magalhães - up201503447@fe.up.pt
 
## 1. Database Workload
 
### 1.1. Tuple Estimation
 
| Relation reference | Relation Name | Order of magnitude        | Estimated growth |
| ------------------ | ------------- | ------------------------- | ---------------- |
| R01                | Comment        | thousands | dozens per day   |
| R02                | Community        | hundreds | units per week |
| R03                | CommunityCategory        | tens | no growth |
| R04                | Community_CommunityCategory    | tens | units per week   |
| R05                | Community_Member        | tens | units per day    |
| R06                | Event        | thousands | units per day   |
| R07                | EventCategory         | tens | no growth |
| R08                | Event_EventCategory         | tens | units per day   |
| R09                | Event_Member         | thousands | units per day    |
| R10                | Friend        | hundreds | dozens per week |
| R11                | Invoice        | hundreds | dozens per week  |
| R12                | Member        | thousands | units per day      |
| R13                | Notification        | thousands | dozens per day        |
| R14                | Report        | tens | units per week   |
| R15                | Ticket        | hundreds | units per week       |
| R16                | TicketType        | hundreds | units per week       |


 
### 1.2. Frequent Queries
 

<table>
 <tr>
  <td><strong>Query Reference</strong></td>
  <td>SELECT01</td>
   </tr>
   <tr>
   <td><strong>Query Description</strong></td>
   <td>User Profile Information</td>
   </tr>
  <tr>
  <td><strong>Query Frequency</strong></td>
  <td>hundreds per day</td>
 </tr>  
</table>

```sql
SELECT name, username, birthdate, email, country, city, address, taxPayerNumber, about, profilePicture, registrationDate
FROM "Member"
WHERE "Member".idMember = $selectedMember;
```

<table>
 <tr>
  <td><strong>Query Reference</strong></td>
  <td>SELECT02</td>
   </tr>
   <tr>
   <td><strong>Query Description</strong></td>
   <td> Member's Activity Feed</td>
   </tr>
  <tr>
  <td><strong>Query Frequency</strong></td>
  <td>hundreds per day</td>
 </tr>  
</table>

```sql
SELECT timestamp, community, recipient, context, comment, event
FROM "notification"
WHERE "notification".recipient = $selectedMember
ORDER BY "notification".timestamp;
```

<table>
 <tr>
  <td><strong>Query Reference</strong></td>
  <td>SELECT03</td>
   </tr>
   <tr>
   <td><strong>Query Description</strong></td>
   <td> Member's Upcoming Events at their Homepage</td>
   </tr>
  <tr>
  <td><strong>Query Frequency</strong></td>
  <td>hundreds per day</td>
 </tr>  
</table>

```sql
SELECT name, description, imagePath, date
FROM "event"
INNER JOIN event_member 
ON event.idevent= event_member.idevent AND "event_member".idmember = $_SESSION["currentMember"]
WHERE "event".date >= $today
Order BY "event".date
LIMIT 3
OFFSET 3;
/* OFFSET skips rows. For pagination, it will be OFFSET 3*($currentPage -1) */
```

<table>
 <tr>
  <td><strong>Query Reference</strong></td>
  <td>SELECT04</td>
   </tr>
   <tr>
   <td><strong>Query Description</strong></td>
   <td> Ticket from an Upcoming Event of a Member</td>
   </tr>
  <tr>
  <td><strong>Query Frequency</strong></td>
  <td>hundreds per month</td>
 </tr>  
</table>

```sql
SELECT *
FROM "TicketType"
WHERE "TicketType".event = $selectedEvent
AND "Ticket".buyer = $_SESSION["currentMember"];
```

<table>
 <tr>
  <td><strong>Query Reference</strong></td>
  <td>SELECT05</td>
   </tr>
   <tr>
   <td><strong>Query Description</strong></td>
   <td> Event's Information</td>
   </tr>
  <tr>
  <td><strong>Query Frequency</strong></td>
  <td>hundreds per day</td>
 </tr>  
</table>

```sql
SELECT name, description, imagePath, date, country, city, address
FROM "event"
WHERE "event".idEvent = $selectedEvent;
```

<table>
 <tr>
  <td><strong>Query Reference</strong></td>
  <td>SELECT06</td>
   </tr>
   <tr>
   <td><strong>Query Description</strong></td>
   <td> Event's Activity Feed or Comments</td>
   </tr>
  <tr>
  <td><strong>Query Frequency</strong></td>
  <td>hundreds per day</td>
 </tr>  
</table>

```sql
SELECT timestamp, recipient, context, comment, event
FROM "notification"
WHERE "notification".event = $selectedEvent
ORDER BY "notification".timestamp;
```

<table>
 <tr>
  <td><strong>Query Reference</strong></td>
  <td>SELECT07</td>
   </tr>
   <tr>
   <td><strong>Query Description</strong></td>
   <td> Get top Events</td>
   </tr>
  <tr>
  <td><strong>Query Frequency</strong></td>
  <td>hundreds per day</td>
 </tr>  
</table>

```sql
SELECT name, imagePath, date, description
FROM "event" e1
INNER JOIN LATERAL 
(
SELECT COUNT("idmember") as numberMembers
FROM "event_member"
WHERE "event_member".idevent= e1.idevent
) e2 ON true
ORDER BY numberMembers DESC
```

<table>
 <tr>
  <td><strong>Query Reference</strong></td>
  <td>SELECT08</td>
   </tr>
   <tr>
   <td><strong>Query Description</strong></td>
   <td> Community's Information</td>
   </tr>
  <tr>
  <td><strong>Query Frequency</strong></td>
  <td>dozens per day</td>
 </tr>  
</table>

```sql
SELECT name, description, imagePath, creationDate, numberMembers
FROM "community" c1
INNER JOIN LATERAL 
(
SELECT COUNT("idmember") as numberMembers
FROM "community_member"
WHERE "community_member".idcommunity= c1.idcommunity
) c2 ON true
WHERE c1.idcommunity = $selectedCommunity;

/*administrators, categories and members vão ter de se buscar pelo CommunityCategory e Communitymember*/
/* Faltam admins e categorias*/
```

<table>
 <tr>
  <td><strong>Query Reference</strong></td>
  <td>SELECT09</td>
   </tr>
   <tr>
   <td><strong>Query Description</strong></td>
   <td> Community's Activity Feed</td>
   </tr>
  <tr>
  <td><strong>Query Frequency</strong></td>
  <td>hundreds per day</td>
 </tr>  
</table>

```sql
SELECT timestamp, recipient, context, comment, community
FROM "notification"
WHERE "notification".community = $selectedCommunity
ORDER BY "notification".timestamp;
```

<table>
 <tr>
  <td><strong>Query Reference</strong></td>
  <td>SELECT10</td>
   </tr>
   <tr>
   <td><strong>Query Description</strong></td>
   <td> Get top Communities</td>
   </tr>
  <tr>
  <td><strong>Query Frequency</strong></td>
  <td>hundreds per day</td>
 </tr>  
</table>

```sql
SELECT name, description, imagePath, creationDate, numberMembers
FROM "community" c1
INNER JOIN LATERAL 
(
SELECT COUNT("idmember") as numberMembers
FROM "community_member"
WHERE "community_member".idcommunity= c1.idcommunity
) e2 ON true
ORDER BY numberMembers DESC
LIMIT 1
/* we can limit them with the LIMIT*/
```

<table>
 <tr>
  <td><strong>Query Reference</strong></td>
  <td>SELECT11</td>
   </tr>
   <tr>
   <td><strong>Query Description</strong></td>
   <td> Visitor's Upcoming Events</td>
   </tr>
  <tr>
  <td><strong>Query Frequency</strong></td>
  <td>hundreds per day</td>
 </tr>  
</table>

```sql
SELECT name, description, imagePath, date
FROM "event"
WHERE "event".date >= $today
Order BY "event".date
LIMIT 4
```

<table>
 <tr>
  <td><strong>Query Reference</strong></td>
  <td>SELECT12</td>
   </tr>
   <tr>
   <td><strong>Query Description</strong></td>
   <td> Member's joined Events</td>
   </tr>
  <tr>
  <td><strong>Query Frequency</strong></td>
  <td>hundreds per day</td>
 </tr>  
</table>

```sql
SELECT name, description, imagePath, date
FROM "event", "event_member", "member"
WHERE "event".idevent = "event_member".idevent AND "event_member".idmember = $selectedMember
Order BY "event".date
LIMIT 4
```

<table>
 <tr>
  <td><strong>Query Reference</strong></td>
  <td>SELECT13</td>
   </tr>
   <tr>
   <td><strong>Query Description</strong></td>
   <td> Member's joined Communities</td>
   </tr>
  <tr>
  <td><strong>Query Frequency</strong></td>
  <td>hundreds per day</td>
 </tr>  
</table>

```sql
SELECT name, description, imagePath, creationDate, numberMembers
FROM "community" c1, "community_member", "member" WHERE "community_member".idcommunity = c1.idcommunity 
AND "community_member".idmember = $selectedMember
INNER JOIN LATERAL 
(
SELECT COUNT("idmember") as numberMembers
FROM "community_member"
WHERE "community_member".idcommunity= c1.idcommunity
) e2 ON true
ORDER BY numberMembers DESC
LIMIT 1
/* we can limit them with the LIMIT*/
```

<table>
 <tr>
  <td><strong>Query Reference</strong></td>
  <td>SELECT14</td>
   </tr>
   <tr>
   <td><strong>Query Description</strong></td>
   <td>Community Participants</td>
   </tr>
  <tr>
  <td><strong>Query Frequency</strong></td>
  <td>hundreds per day</td>
 </tr>  
</table>

```sql
SELECT "member".username, "member".profilePicture FROM "member", "community", "community_member"
WHERE "community_member".idcommunity = $selectedCommunity AND "member".idmember = "community_member".idmember
```

<table>
 <tr>
  <td><strong>Query Reference</strong></td>
  <td>SELECT15</td>
   </tr>
   <tr>
   <td><strong>Query Description</strong></td>
   <td>Event Participants</td>
   </tr>
  <tr>
  <td><strong>Query Frequency</strong></td>
  <td>hundreds per day</td>
 </tr>  
</table>

```sql
SELECT "member".username, "member".profilePicture FROM "member", "event", "event_member"
WHERE "event_member".idevent = $selectedEvent AND "member".idmember = "event_member".idmember
```
 
### 1.3. Frequent Updates
 
 
 
 UPDATES
 
 
 
 
<table>
 <tr>
  <td><strong>Query Reference</strong></td>
  <td>UPDATE01</td>
   </tr>
   <tr>
   <td><strong>Query Description</strong></td>
   <td>Updating a Community's Information</td>
   </tr>
  <tr>
  <td><strong>Query Frequency</strong></td>
  <td>hundreds per day</td>
 </tr>  
</table>

```sql
UPDATE "community"
  SET name = $name, description = $des, imagePath = $image, isPublic = $isPublic 
  WHERE "idevent" = $id; 
```

<table>
 <tr>
  <td><strong>Query Reference</strong></td>
  <td>UPDATE02</td>
   </tr>
   <tr>
   <td><strong>Query Description</strong></td>
   <td>Updating an Event's Information</td>
   </tr>
  <tr>
  <td><strong>Query Frequency</strong></td>
  <td>hundreds per day</td>
 </tr>  
</table>

```sql
UPDATE "event"
  SET name = $name, description = $des, country = $country, city = $city
  WHERE "idevent" = $id; 
```

<table>
 <tr>
  <td><strong>Query Reference</strong></td>
  <td>UPDATE03</td>
   </tr>
   <tr>
   <td><strong>Query Description</strong></td>
   <td>Updating a Member's Information</td>
   </tr>
  <tr>
  <td><strong>Query Frequency</strong></td>
  <td>hundreds per day</td>
 </tr>  
</table>

```sql
UPDATE "member"
  SET name = $name, password = $password, country = $country, city = $city, address = $address, taxpayernumber = $payerNumber, about = $des, profilepicture = $profilePic
  WHERE "idmember" = $id; 
```

<table>
 <tr>
  <td><strong>Query Reference</strong></td>
  <td>UPDATE04</td>
   </tr>
   <tr>
   <td><strong>Query Description</strong></td>
   <td>Add/remove new Admin from Event</td>
   </tr>
  <tr>
  <td><strong>Query Frequency</strong></td>
  <td>hundreds per day</td>
 </tr>  
</table>

```sql
UPDATE "event_member" 
  SET isAdmin = $permissions
  WHERE "idmember" = $selectedMember
  AND "idevent" = $selectedEvent; 
```
 
 
<table>
 <tr>
  <td><strong>Query Reference</strong></td>
  <td>UPDATE05</td>
   </tr>
   <tr>
   <td><strong>Query Description</strong></td>
   <td>Add/remove new Admin from Community</td>
   </tr>
  <tr>
  <td><strong>Query Frequency</strong></td>
  <td>hundreds per day</td>
 </tr>  
</table>

```sql
UPDATE "community_member" 
  SET isAdmin = $permissions
  WHERE "idmember" = $selectedMember
  AND "idcommunity" = $selectedCommunity; 
```

<table>
 <tr>
  <td><strong>Query Reference</strong></td>
  <td>UPDATE05</td>
   </tr>
   <tr>
   <td><strong>Query Description</strong></td>
   <td>Make Member a Website Admin</td>
   </tr>
  <tr>
  <td><strong>Query Frequency</strong></td>
  <td>hundreds per day</td>
 </tr>  
</table>

```sql
UPDATE "member" 
  SET isWebsiteAdmin = $permissions
  WHERE idmember = $selectedMember;
```

<table>
 <tr>
  <td><strong>Query Reference</strong></td>
  <td>UPDATE06</td>
   </tr>
   <tr>
   <td><strong>Query Description</strong></td>
   <td>Solve a Report</td>
   </tr>
  <tr>
  <td><strong>Query Frequency</strong></td>
  <td>hundreds per day</td>
 </tr>  
</table>

```sql
UPDATE "report" 
  SET solved = true
  WHERE idReport = $selectedReport;
```



INSERTS








<table>
 <tr>
  <td><strong>Query Reference</strong></td>
  <td>INSERT01</td>
   </tr>
   <tr>
   <td><strong>Query Description</strong></td>
   <td>Create a new Event</td>
   </tr>
  <tr>
  <td><strong>Query Frequency</strong></td>
  <td>hundreds per day</td>
 </tr>  
</table>

```sql
INSERT INTO "event" VALUES
 ($id, $name, $description, $imagePath, $startDay, $endDay, $startTime, $endTime, $country, $city, $address, $publicLink, $isPublic, null);
```

<table>
 <tr>
  <td><strong>Query Reference</strong></td>
  <td>INSERT02</td>
   </tr>
   <tr>
   <td><strong>Query Description</strong></td>
   <td>Member Joining Event</td>
   </tr>
  <tr>
  <td><strong>Query Frequency</strong></td>
  <td>hundreds per day</td>
 </tr>  
</table>

```sql
INSERT INTO "event_member" VALUES
 ($selectedEvent, $_SESSION["currentMember"], false);
```

<table>
 <tr>
  <td><strong>Query Reference</strong></td>
  <td>INSERT03</td>
   </tr>
   <tr>
   <td><strong>Query Description</strong></td>
   <td>Add a Comment to the Event</td>
   </tr>
  <tr>
  <td><strong>Query Frequency</strong></td>
  <td>hundreds per day</td>
 </tr>  
</table>

```sql
INSERT INTO "comment" VALUES
 ($idcomment, $content, $timestamp, $selectedEvent, $_SESSION["currentMember"]);
```


<table>
 <tr>
  <td><strong>Query Reference</strong></td>
  <td>INSERT04</td>
   </tr>
   <tr>
   <td><strong>Query Description</strong></td>
   <td>Invite a Member</td>
   </tr>
  <tr>
  <td><strong>Query Frequency</strong></td>
  <td>hundreds per day</td>
 </tr>  
</table>

```sql
INSERT INTO "notification" VALUES
 ($idNnotification, $timestamp, 'event', null, $_SESSION["currentMember"], 'You were invited to', null, $idEvent);
```


<table>
 <tr>
  <td><strong>Query Reference</strong></td>
  <td>INSERT05</td>
   </tr>
   <tr>
   <td><strong>Query Description</strong></td>
   <td>Create a new Community</td>
   </tr>
  <tr>
  <td><strong>Query Frequency</strong></td>
  <td>hundreds per day</td>
 </tr>  
</table>

```sql
INSERT INTO "event" VALUES
 ($id, $name, $description, $timestamp, $imagePath, $publicLink, $isPublic);
```

<table>
 <tr>
  <td><strong>Query Reference</strong></td>
  <td>INSERT06</td>
   </tr>
   <tr>
   <td><strong>Query Description</strong></td>
   <td>Member Joining Community</td>
   </tr>
  <tr>
  <td><strong>Query Frequency</strong></td>
  <td>hundreds per day</td>
 </tr>  
</table>

```sql
INSERT INTO "community_member" VALUES
 ($selectedCommunity, $_SESSION["currentMember"], false);
```

<table>
 <tr>
  <td><strong>Query Reference</strong></td>
  <td>INSERT07</td>
   </tr>
   <tr>
   <td><strong>Query Description</strong></td>
   <td>Invite a member</td>
   </tr>
  <tr>
  <td><strong>Query Frequency</strong></td>
  <td>hundreds per day</td>
 </tr>  
</table>


```sql
INSERT INTO "notification" VALUES
 ($idNnotification, $timestamp, 'community', $idCommunity, $_SESSION["currentMember"], 'You were invited to', null, null);
```

<table>
 <tr>
  <td><strong>Query Reference</strong></td>
  <td>INSERT08</td>
   </tr>
   <tr>
   <td><strong>Query Description</strong></td>
   <td>Create an event for a community</td>
   </tr>
  <tr>
  <td><strong>Query Frequency</strong></td>
  <td>hundreds per day</td>
 </tr>  
</table>


```sql
INSERT INTO "event" VALUES
 ($id, $name, $description, $imagePath, $startDay, $endDay, $startTime, $endTime, $country, $city, $address, $publicLink, $isPublic, $idCommunity);
```

<table>
 <tr>
  <td><strong>Query Reference</strong></td>
  <td>INSERT09</td>
   </tr>
   <tr>
   <td><strong>Query Description</strong></td>
   <td>Register</td>
   </tr>
  <tr>
  <td><strong>Query Frequency</strong></td>
  <td>hundreds per day</td>
 </tr>  
</table>


```sql
INSERT INTO "member" VALUES
 ($id, $name, $username, $password, $birthdate, $email, $country, $city, $address, $payerNumber, $about, $profilePicture, $timestamp, $sentEmailVerification, $verifiedEmail, false);
```


<table>
 <tr>
  <td><strong>Query Reference</strong></td>
  <td>INSERT10</td>
   </tr>
   <tr>
   <td><strong>Query Description</strong></td>
   <td>Member purchasing a ticket</td>
   </tr>
  <tr>
  <td><strong>Query Frequency</strong></td>
  <td>hundreds per day</td>
 </tr>  
</table>
```sql
NAO FAÇO A MENOR IDEIA

```

<table>
 <tr>
  <td><strong>Query Reference</strong></td>
  <td>INSERT11</td>
   </tr>
   <tr>
   <td><strong>Query Description</strong></td>
   <td>File a Report</td>
   </tr>
  <tr>
  <td><strong>Query Frequency</strong></td>
  <td>hundreds per day</td>
 </tr>  
</table>
```sql
INSERT INTO "report" VALUES
 ($idReport, $timestamp, $type, $context, $community, $reporter, $comment, $event);
```

 
 
DELETES


<table>
 <tr>
  <td><strong>Query Reference</strong></td>
  <td>DELETE01</td>
   </tr>
   <tr>
   <td><strong>Query Description</strong></td>
   <td>Report</td>
   </tr>
  <tr>
  <td><strong>Query Frequency</strong></td>
  <td>hundreds per day</td>
 </tr>  
</table>

```sql
DELETE FROM "comment"
  WHERE "idcomment" == $selectedComment
  AND "author" == $_SESSION['currentMember'];
```


Eventos:
 remover membros (flag)
 comprar bilhete
 
  
Comunidades:
 remover membros (flag)
 
 
Website Admin
 "banir" evento
 "banir" comunidade
 "banir" membro

 
 
## 2. Proposed Indices
 
### 2.1. Performance Indices
 
> Indices proposed to improve performance of the identified queries.
 
| Index reference | IDX01                                  |
| Related queries | SELECT01, ...                          |
| Index relation  | Relation where the index is applied    |
| Index attribute | Attribute where the index is applied   |
| Index type      | B-tree, Hash, GiST or GIN              |
| Cardinality     | Attribute cardinality: low/medium/high |
| Clustering      | Clustering of the index                |
| --------------- | -------------------------------------- |
| Justification   | Justification for the proposed index   |
| --------------- | -------------------------------------- |
| SQL code                                                 |
 
 
### 2.2. Full-text Search Indices 
 
> The system being developed must provide full-text search features supported by PostgreSQL. Thus, it is necessary to specify the fields where full-text search will be available and the associated setup, namely all necessary configurations, indexes definitions and other relevant details.
 
| Index reference | IDX01                                  |
| Related queries | SELECT01, ...                          |
| Index relation  | Relation where the index is applied    |
| Index attribute | Attribute where the index is applied   |
| Index type      | B-tree, Hash, GiST or GIN              |
| Clustering      | Clustering of the index                |
| --------------- | -------------------------------------- |
| Justification   | Justification for the proposed index   |
| --------------- | -------------------------------------- |
| SQL code                                                 |
 
 
## 3. Triggers
 
 
 
 
 TRIGGERS:
  Quando membro é banido, os comentários não são retirados, apenas ficam a null. Depois em PHP é que se indica que foi flagged 
   
  Quando evento de comunidade é criado, todas as pessoas dessa comunidade são convidadas para esse evento
  
  Quando uma amizade é aceite é criada a amizade reflexa(verificar se relação é unidirecional)
  
<table>
 <tr>
  <td><strong>Trigger Reference</strong></td>
  <td>TRIGGER01</td>
   </tr>
   <tr>
   <td><strong>Trigger Description</strong></td>
   <td>When a community event is created, every Member of the community is invited to that event</td>
   </tr>
</table>

```sql
CREATE FUNCTION inviteAllMembers() RETURNS TRIGGER AS
$BODY$
BEGIN
      
 
END
$BODY$
LANGUAGE plpgsql;
 
CREATE TRIGGER eventCommunity
  AFTER INSERT ON EVENT
  FOR EACH ROW
    EXECUTE PROCEDURE inviteAllMembers(); 
```
 
 
## 4. Complete SQL Code
 
> The database script must also include the SQL to populate a database with test data with an amount of tuples suitable for testing and with plausible values for the fields of the database.
> This code should also be included in the group's github repository as an SQL script, and a link include here.
 
 
